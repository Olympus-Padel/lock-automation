name: Generate Lock Pins

on:
  schedule:
    # Runs every day at 5:00am UTC (10:00pm or 11:00pm Mountain Time, depending on daylight savings)
    - cron: "0 5 * * *"
  workflow_dispatch:
    # Allows manual triggering of the workflow

jobs:
  generate-lock-pins:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Set up the environment
        uses: ./.github/actions/setup-python-env

      - name: Install Playwright browser and dependencies
        run: uv run playwright install --with-deps chromium

      - name: Generate lock pins for the Denver court
        run: |
          uv run python -m lock_automation.generate_codes_cli \
            --igloo-client-id "${{ secrets.IGLOO_CLIENT_ID }}" \
            --igloo-client-secret "${{ secrets.IGLOO_CLIENT_SECRET }}" \
            --igloo-lock-id "${{ secrets.DENVER_LOCK_ID }}" \
            --play-by-point-username "${{ secrets.PLAY_BY_POINT_USERNAME }}" \
            --play-by-point-password "${{ secrets.PLAY_BY_POINT_PASSWORD }}" \
            --play-by-point-owner "${{ secrets.DENVER_PLAY_BY_POINT_OWNER }}" \
            --timezone "America/Denver"

  keepalive-job:
    name: Keepalive Workflow
    if: ${{ always() }}
    needs: generate-lock-pins
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Keep workflow alive
        run: |
          last_commit_date=$(git log -1 --format=%ct)
          current_date=$(date +%s)
          days_since_commit=$(( (current_date - last_commit_date) / 86400 ))

          echo "Days since last commit: $days_since_commit"

          if [ "$days_since_commit" -gt 45 ]; then
            echo "Last commit was more than 45 days ago. Creating keep-alive commit."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit --allow-empty -m "Keep-alive: prevent workflow from being disabled"
            git push
          else
            echo "Last commit was $days_since_commit days ago. No action needed."
          fi
